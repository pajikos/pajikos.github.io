<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>Parallel Processing in Java - blog.pavelsklenar.com</title><meta name=description content="Personal blog page"><meta property="og:title" content="Parallel Processing in Java">
<meta property="og:description" content="This post shows how to implement parallelism in Java using its native java.util.concurrent classes.
I mean especially using parallel Fork-Join Framework (available since Java 1.7), which is most suitable for processing of high complex (CPU intensive) tasks. I mean that case when you have one very complex task and you want to use all of your available computing resources to process your single task in the fastest time.
The basic idea of the Fork-Join Framework concerns &ldquo;Divide and Conquer&rdquo;.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.pavelsklenar.com/parallel-processing-java/"><meta property="og:image" content="https://blog.pavelsklenar.com/logo.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-03-18T00:00:00+00:00">
<meta property="article:modified_time" content="2021-09-20T22:40:20+02:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.pavelsklenar.com/logo.png">
<meta name=twitter:title content="Parallel Processing in Java">
<meta name=twitter:description content="This post shows how to implement parallelism in Java using its native java.util.concurrent classes.
I mean especially using parallel Fork-Join Framework (available since Java 1.7), which is most suitable for processing of high complex (CPU intensive) tasks. I mean that case when you have one very complex task and you want to use all of your available computing resources to process your single task in the fastest time.
The basic idea of the Fork-Join Framework concerns &ldquo;Divide and Conquer&rdquo;.">
<meta name=application-name content="blog.pavelsklenar.com">
<meta name=apple-mobile-web-app-title content="blog.pavelsklenar.com"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.pavelsklenar.com/parallel-processing-java/><link rel=prev href=https://blog.pavelsklenar.com/using-filteredrowset-simple-example/><link rel=next href=https://blog.pavelsklenar.com/spring-integration-sftp-upload-example/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.623091c4f3b927646c79b3db3772f496ee423628b9567bc0c74af55a4d50d1ba.css integrity="sha256-YjCRxPO5J2RsebPbN3L0lu5CNii5VnvAx0r1Wk1Q0bo="><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Parallel Processing in Java","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.pavelsklenar.com\/parallel-processing-java\/"},"image":[{"@type":"ImageObject","url":"https:\/\/blog.pavelsklenar.com\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"posts","wordcount":2005,"url":"https:\/\/blog.pavelsklenar.com\/parallel-processing-java\/","datePublished":"2016-03-18T00:00:00+00:00","dateModified":"2021-09-20T22:40:20+02:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Pavel Sklenar","logo":{"@type":"ImageObject","url":"https:\/\/blog.pavelsklenar.com\/images\/avatar.png","width":250,"height":250}},"author":{"@type":"Person","name":"Pavel Sklenar"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>('false'==='true'&&window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=blog.pavelsklenar.com><span class=header-title-pre><i class="fas fa-code-branch fa-fw"></i></span>blog.pavelsklenar.com</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> Posts </a><a class=menu-item href=/tags/> Tags </a><a class=menu-item href=/categories/> Categories </a><a class=menu-item href=/about/> About </a><a class=menu-item href=https://github.com/pajikos title=GitHub rel="noopener noreferrer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=blog.pavelsklenar.com><span class=header-title-pre><i class="fas fa-code-branch fa-fw"></i></span>blog.pavelsklenar.com</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/pajikos title=GitHub rel="noopener noreferrer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">Parallel Processing in Java</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>Pavel Sklenar</a></span>&nbsp;<span class=post-category>included in <a href=/categories/java/><i class="far fa-folder fa-fw"></i>java</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2016-03-18>2016-03-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2005 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;10 minutes&nbsp;<span id=/parallel-processing-java/ class=leancloud_visitors data-flag-title="Parallel Processing in Java">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#how-to-choose-an-appropriate-big-task>How to choose an appropriate big task</a></li>
<li><a href=#how-to-create-recursiveaction>How to create RecursiveAction</a>
<ul>
<li><a href=#compute>Compute()</a></li>
<li><a href=#fork>Fork()</a></li>
<li><a href=#join>Join()</a></li>
</ul>
</li>
<li><a href=#how-to-call-your-own-recursiveaction>How to call your own RecursiveAction</a></li>
<li><a href=#performancetest>Performance test</a>
<ul>
<li><a href=#the-rules-of-the-gamenumber-one>The rules of the game number ONE</a></li>
<li><a href=#the-rules-of-the-gamenumber-two>The rules of the game number TWO</a></li>
</ul>
</li>
<li><a href=#summary>Summary</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>This post shows how to implement parallelism in Java using its native  <code>java.util.concurrent</code> classes.</p>
<p>I mean especially using parallel Fork-Join Framework (available since Java 1.7), which is most suitable for processing of high complex (CPU intensive) tasks. I mean that case when you have one very complex task and you want to use all of your available computing resources to process your single task in the fastest time.</p>
<p>The basic idea of the Fork-Join Framework concerns &ldquo;Divide and Conquer&rdquo;. You need to split a big task up into enough subtasks to keep all of your CPUs utilized. You have no limit how many times you subdivide a task but be aware that a subdividing adds some overhead as well. It can be a little hard to determine the number of subtasks. I will discuss it later with a benchmark example.</p>
<p>The Fork-Join Framework offers two basic abstract tasks: <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/RecursiveAction.html target=_blank rel="noopener noreferrer">RecursiveAction</a> and <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/RecursiveTask.html target=_blank rel="noopener noreferrer">RecursiveTask.</a></p>
<p>The basic difference is related to its return value. <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/RecursiveTask.html target=_blank rel="noopener noreferrer">RecursiveTask</a> is appropriate when you need to return a result from your task, e.g. sorting a really huge array. A result of each subtask needs to be compared with each other. This task is a little bit harder to code.</p>
<p><a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/RecursiveAction.html target=_blank rel="noopener noreferrer">RecursiveAction</a> does not return any result, you can use it e.g. to initialize a big array with some custom values. Each of subtask works alone on its own piece of that array.</p>
<h2 id=how-to-choose-an-appropriate-big-task>How to choose an appropriate big task</h2>
<p>I would like to make a benchmark with a parallel processing, so I need to choose a really CPU intensive task. The opposite - I/O intensive tasks are not clear because you may not see any performance benefits using parallelism, e.g. processing of a big file from a file system, where you can suffer from reading to slow from your disc.</p>
<p>I&rsquo;ve chosen a computation of all prime numbers up to a defined limit. This post is not about choosing the best and most efficient algorithm to check whether a number is prime or not, but I have used a little bit optimized way to check a number is prime (inspired by <a href=http://java67.blogspot.cz/2014/01/how-to-check-if-given-number-is-prime.html target=_blank rel="noopener noreferrer">Javin Paul&rsquo;s blog page</a>):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isPrime</span><span class=o>(</span><span class=kt>int</span> <span class=n>num</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>num</span> <span class=o>==</span> <span class=n>2</span> <span class=o>||</span> <span class=n>num</span> <span class=o>==</span> <span class=n>3</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
    <span class=o>}</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>num</span> <span class=o>%</span> <span class=n>2</span> <span class=o>==</span> <span class=n>0</span> <span class=o>||</span> <span class=n>num</span> <span class=o>%</span> <span class=n>3</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
    <span class=o>}</span>
    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>3</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>Math</span><span class=o>.</span><span class=na>sqrt</span><span class=o>(</span><span class=n>num</span><span class=o>);</span> <span class=n>i</span> <span class=o>+=</span> <span class=n>2</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>num</span> <span class=o>%</span> <span class=n>i</span> <span class=o>==</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=kc>false</span><span class=o>;</span>
        <span class=o>}</span>
    <span class=o>}</span>
    <span class=k>return</span> <span class=kc>true</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></div><p>Basically, it consists of testing whether a num variable is multiple of any integer between 2 and sqrt{n} with some improvements, e.g. skipping even numbers.</p>
<h2 id=how-to-create-recursiveaction>How to create RecursiveAction</h2>
<p>In a case you want to implement a <code>RecursiveAction</code>, you need to create your own class which extends from <code>java.util.concurrent.RecursiveAction</code> (which is actually an abstract class) and implement it&rsquo;s abstract method <code>compute():</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>class</span> <span class=nc>PrimeRecursiveAction</span> <span class=kd>extends</span> <span class=n>RecursiveAction</span> <span class=o>{</span>
 
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>threshold</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>data</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>start</span><span class=o>;</span>
    <span class=kd>private</span> <span class=kt>int</span> <span class=n>end</span><span class=o>;</span>
 
    <span class=kd>public</span> <span class=nf>PrimeRecursiveAction</span><span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>data</span><span class=o>,</span> <span class=kt>int</span> <span class=n>start</span><span class=o>,</span> <span class=kt>int</span> <span class=n>end</span><span class=o>,</span>
            <span class=kt>int</span> <span class=n>threshold</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>data</span> <span class=o>=</span> <span class=n>data</span><span class=o>;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>start</span> <span class=o>=</span> <span class=n>start</span><span class=o>;</span> <span class=c1>// start to process from
</span><span class=c1></span>        <span class=k>this</span><span class=o>.</span><span class=na>end</span> <span class=o>=</span> <span class=n>end</span><span class=o>;</span> <span class=c1>// end of processing
</span><span class=c1></span>        <span class=k>this</span><span class=o>.</span><span class=na>threshold</span> <span class=o>=</span> <span class=n>threshold</span><span class=o>;</span>
    <span class=o>}</span>
     
    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>compute</span><span class=o>()</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>end</span> <span class=o>-</span> <span class=n>start</span> <span class=o>&lt;=</span> <span class=n>threshold</span><span class=o>)</span> <span class=o>{</span> <span class=c1>// Am I able to process it alone?
</span><span class=c1></span>            <span class=c1>// do the task
</span><span class=c1></span>            <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>start</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>end</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                <span class=k>if</span> <span class=o>(</span><span class=n>PrimeNumberUtil</span><span class=o>.</span><span class=na>isPrime</span><span class=o>(</span><span class=n>i</span><span class=o>))</span> <span class=o>{</span>
                    <span class=n>data</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>i</span><span class=o>);</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span> <span class=c1>// split too big task
</span><span class=c1></span>            <span class=kt>int</span> <span class=n>halfAmount</span> <span class=o>=</span> <span class=o>((</span><span class=n>end</span> <span class=o>-</span> <span class=n>start</span><span class=o>)</span> <span class=o>/</span> <span class=n>2</span><span class=o>)</span> <span class=o>+</span> <span class=n>start</span><span class=o>;</span>
            <span class=n>PrimeRecursiveAction</span> <span class=n>leftTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrimeRecursiveAction</span><span class=o>(</span><span class=n>data</span><span class=o>,</span>
                    <span class=n>start</span><span class=o>,</span> <span class=n>halfAmount</span><span class=o>,</span> <span class=n>threshold</span><span class=o>);</span>
            <span class=n>leftTask</span><span class=o>.</span><span class=na>fork</span><span class=o>();</span> <span class=c1>// add left task to the queue
</span><span class=c1></span>            <span class=n>PrimeRecursiveAction</span> <span class=n>rightTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrimeRecursiveAction</span><span class=o>(</span><span class=n>data</span><span class=o>,</span>
                    <span class=n>halfAmount</span><span class=o>,</span> <span class=n>end</span><span class=o>,</span> <span class=n>threshold</span><span class=o>);</span>
            <span class=n>rightTask</span><span class=o>.</span><span class=na>compute</span><span class=o>();</span> <span class=c1>// work on right task, this is a recursive call
</span><span class=c1></span>            <span class=n>leftTask</span><span class=o>.</span><span class=na>join</span><span class=o>();</span> <span class=c1>// wait for queued task to be completed
</span><span class=c1></span>        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>The following method calls are very important: <code>compute(), fork(),</code> and <code>join().</code></p>
<h3 id=compute>Compute()</h3>
<p>As I said before, the main part to be coded is a decision how many levels of recursion are appropriate (i.e. the first condition including the <code>threshold</code> variable).</p>
<p>The main question is: Am I able to process it alone?</p>
<p>When you call <code>compute()</code> on the <code>rightTask</code> actually you are doing a recursive call.</p>
<h3 id=fork>Fork()</h3>
<p>With the Fork-Join Framework, each thread in the <code>ForkJoinPool</code> has a queue of the tasks it is working on. The calling of <code>fork()</code> method places our newly created <code>PrimeRecursiveAction</code> in the current thread&rsquo;s task queue. A key feature of the Fork-Join Framework is work (task) stealing. Stealing means that the other free threads in a ForkJoinPool (if any) may take and process these tasks.</p>
<h3 id=join>Join()</h3>
<p>When you call <code>join()</code> on the left (previously forked) task, it should be one of the last steps after calling <code>fork()</code> and <code>compute()</code>. Calling <code>join()</code> means that &ldquo;I can&rsquo;t continue unless this (left) task is done.&rdquo; But calling <code>join()</code> is not only about waiting.</p>
<p>The task you call <code>join()</code> on can still be in the queue (not stolen). In this case, the thread calling <code>join()</code> will execute the joined task.</p>
<p>To simplify you can replace lines with calling <code>fork()</code>, <code>compute()</code> and <code>join()</code> with the following call <code>invokeAll(rightTask, leftTask)</code>. Using that will also help you to avoid possible bugs with calling fork-compute-join methods in the correct order - just for completeness.</p>
<h2 id=how-to-call-your-own-recursiveaction>How to call your own RecursiveAction</h2>
<p>You need to create a new instance of your <code>RecursiveAction</code> implementation (i.e. <code>PrimeRecursiveAction</code> in our case) and invoke it using <code>ForkJoinPool</code>. The <code>class java.util.concurrent.ForkJoinPool</code> is a highly specialized <code>ExecutorService</code> which takes in a case of no-arg <code>ForkJoinPool</code> constructor creates an instance that will use the <code>Runtime.availableProcessors()</code> method to determine the level of parallelism. It exists also a  <code>ForkJoinPool(int parallelism)</code> constructor that allows you to set the number of threads that will be used to process your task.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>Set</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span> <span class=n>data</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentSkipListSet</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;();</span>
<span class=n>ForkJoinPool</span> <span class=n>fjPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ForkJoinPool</span><span class=o>()</span>
<span class=n>PrimeRecursiveAction</span> <span class=n>action</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PrimeRecursiveAction</span><span class=o>(</span><span class=n>data</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>100</span><span class=o>,</span> <span class=n>5</span><span class=o>);</span>
<span class=n>fjPool</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>action</span><span class=o>);</span>
</code></pre></div><p>The constructor of the <code>PrimeRecursiveAction</code> needs an instance <code>Set</code> of <code>Integers</code> (to save prime numbers), a search interval to find prime numbers (we are looking for prime numbers from 0 to 100 now) and a <code>threshold</code> value.</p>
<p>As you may have noticed, I had used a new instance of an ordered <code>[ConcurrentSkipListSet](https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentSkipListSet.html).</code> This implementation is based on a <a href=https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentSkipListMap.html title="class in java.util.concurrent" target=_blank rel="noopener noreferrer"><code>ConcurrentSkipListMap</code></a> and its concurrency support is required because multiple threads are adding values concurrently. When you do not need natural order sorting, you can use a <code>Set</code> based on a faster <code>[ConcurrentHashMap](https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentHashMap.html)</code> (<code>ConcurrentHashMap.newKeySet()</code>).</p>
<h2 id=performancetest>Performance test</h2>
<p>The decision how many levels of recursion are appropriate is one of the most important things that you need to do. You need to create enough subtasks that you keep all of your CPUs utilized all the time of the whole processing.</p>
<p>I made a benchmark to find out the right size of the subtask, i.e. the <code>threshold</code> value. I mean the state when the current thread does not need to create another subtask anymore and is able to start checking whether a number is prime or not in its interval.</p>
<h3 id=the-rules-of-the-gamenumber-one>The rules of the game number ONE</h3>
<p>There are many factors that can influence the appropriate <code>threshold</code> value. You have to take into account number of parallelism you have available. The decision about processing a task alone or creating other recursion calls including a management of the task queue consume your resources as well.</p>
<p>When you creates too many subtasks, your task queue management consumes too many resources. On the other hand, a large <code>threshold</code> value does not keep utilized all of your CPUs at the same time. Some threads become free (no other tasks to process in the queue), but another thread might be still processing its big task.</p>
<p>All of this vary on the amount of the required work, i.e. the upper limit where the application stops to search for prime numbers.</p>
<p>So this my starting point:</p>
<table><tbody><tr><td><strong>Available parallelism:</strong></td><td>4</td></tr><tr><td><strong>The upper limit of the search:</strong></td><td>30 000 000 (this value has no special meaning, I just needed a big task, but no too big :))</td></tr><tr><td><strong>Threshold values to test:</strong></td><td>1, 100, 10 000, 1 000 000 (i.e. 4 variants)</td></tr><tr><td><strong>Number of attempts for each&nbsp;variant:</strong></td><td>4, (actually 6, but the worst and the best result will be skipped)</td></tr></tbody></table>
<p>The Graph 1 shows my benchmark result. The x-axis is a time in seconds, the y-axis is the threshold value used in the each test.</p>
<p><figure><a class=lightgallery href=/parallel-processing-java/images/graf.png title="Graph 1: The test duration for each variant of the threshold value." data-thumbnail=/parallel-processing-java/images/graf.png data-sub-html="<h2>Graph 1: The test duration for each variant of the threshold value.</h2><p>Graph 1: The test duration for each variant of the threshold value.</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=images/graf.png data-srcset="/parallel-processing-java/images/graf.png, images/graf.png 1.5x, /parallel-processing-java/images/graf.png 2x" data-sizes=auto alt=/parallel-processing-java/images/graf.png>
</a><figcaption class=image-caption>Graph 1: The test duration for each variant of the threshold value.</figcaption>
</figure></p>
<p>As you can see the most appropriate threshold value is 100 in my case (4 available threads and the limit of the search equals to 30 000 000).</p>
<p>In a case of the large threshold (1 000 000), one CPU was still processing its task, but other CPUs have already processed rest of tasks. See my CPU load, the first attempt is with threshold 1 000 000, the second one with threshold 100:</p>
<p><figure><a class=lightgallery href=/parallel-processing-java/images/2016-03-06-20_06_17-System-Information-1-1024x403.png title="Graph 2: The load of the CPU during processing the threshold value 1 000 000 and 100." data-thumbnail=/parallel-processing-java/images/2016-03-06-20_06_17-System-Information-1-1024x403.png data-sub-html="<h2>Graph 2: The load of the CPU during processing with the threshold value 1 000 000 and 100.</h2><p>Graph 2: The load of the CPU during processing the threshold value 1 000 000 and 100.</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=images/2016-03-06-20_06_17-System-Information-1-1024x403.png data-srcset="/parallel-processing-java/images/2016-03-06-20_06_17-System-Information-1-1024x403.png, images/2016-03-06-20_06_17-System-Information-1-1024x403.png 1.5x, /parallel-processing-java/images/2016-03-06-20_06_17-System-Information-1-1024x403.png 2x" data-sizes=auto alt=/parallel-processing-java/images/2016-03-06-20_06_17-System-Information-1-1024x403.png>
</a><figcaption class=image-caption>Graph 2: The load of the CPU during processing with the threshold value 1 000 000 and 100.</figcaption>
</figure></p>
<p>The reason for the low performance in a case of large threshold values is clear.</p>
<p>The threshold value 1 was slower than 100, but why? The most probable reason is too many recursions calls created during processing. See the following statistic:</p>
<table><tbody><tr><td><strong>The upper limit of the search</strong></td><td><strong>Threshold values</strong></td><td><strong>The number of all created tasks during processing</strong></td></tr><tr><td>&nbsp;30 000 000</td><td>1</td><td>59 999 999</td></tr><tr><td>&nbsp;30 000 000</td><td>&nbsp;100</td><td>1 048 575</td></tr><tr><td>30 000 000</td><td>10 000</td><td>8 191</td></tr><tr><td>30 000 000</td><td>1 000 000</td><td>63</td></tr></tbody></table>
<h3 id=the-rules-of-the-gamenumber-two>The rules of the game number TWO</h3>
<p>In the previous test, we found that the most appropriate threshold value is 100 (in a case of the upper limit of the search 30 millions).</p>
<p>I would like to know the gain of using parallel processing. I will test each of available levels of parallelism, i.e. 1-4 (on my PC) with the <code>RecursiveAction</code>. At the end, I will try to process the task without the <code>RecursviceAction</code>, simply without creating any subtasks, recursive calls and dividing intervals. Of cause, the last test will be processed by one thread only.</p>
<p>So this my starting point:</p>
<table><tbody><tr><td><strong>Number of available parallelisms to test:</strong></td><td>1-4 using ForkJoinPool and RecursiveAction, 1 using simple processing &nbsp; (i.e. 5 variants)</td></tr><tr><td><strong>The upper limit of the search:</strong></td><td>30 000 000 (this value has no special meaning, I just needed a big task, but no too big :))</td></tr><tr><td><strong>Threshold value:</strong></td><td>100</td></tr><tr><td><strong>Number of attempts for each&nbsp;variant:</strong></td><td>4, (actually 6, but the worst and the best result will be skipped)</td></tr></tbody></table>
<p>Here is the result, the x-axis is a time in seconds, the y-axis is the level of parallelism used in the each test.</p>
<p><figure><a class=lightgallery href=/parallel-processing-java/images/graf.png title="Graph 3: The test duration for each variant of the parallelism level." data-thumbnail=/parallel-processing-java/images/graf.png data-sub-html="<h2>Graph 3: The test duration for each variant of the parallelism level.</h2><p>Graph 3: The test duration for each variant of the parallelism level.</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=images/graf.png data-srcset="/parallel-processing-java/images/graf.png, images/graf.png 1.5x, /parallel-processing-java/images/graf.png 2x" data-sizes=auto alt=/parallel-processing-java/images/graf.png>
</a><figcaption class=image-caption>Graph 3: The test duration for each variant of the parallelism level.</figcaption>
</figure></p>
<p>As you can see, the benefit of higher parallelism level is obvious, but it does not mean, that the half number of available thread means twice as much time to process the same amount of work.</p>
<p>There is another interesting fact about difference between using ForkJoinPool with RecursiveAction and using a simple processing algorithm (using a for cycle, for more information, check the code on my <a href=https://github.com/pajikos/RecursiveActionExample target=_blank rel="noopener noreferrer">GitHub</a>). I had suspected that the management about the queuing newly created tasks would lead to longer time in processing.  The measured results do not show any difference between these two options. The overhead in management is probably not so huge to affect the result.</p>
<h2 id=summary>Summary</h2>
<p>The Fork-Join Framework is very easy to implement by using <code>ForkJoinPool</code> and its <code>RecursiveAction</code> task.</p>
<p>On the other hand, you have to consider whether your task is appropriate for parallel processing. If it is, you have to tune in the correct parameters (e.g. the threshold value, a level of parallelism etc.), otherwise your result will be worse than another simpler solution without using the Fork-Join Framework.</p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2021-09-20&nbsp;<a class=git-hash href=https://github.com/pajikos/commit/f5d3ae45f5183f44c2c5404fa2bb327ad1e0ed43 target=_blank rel="noopener noreferrer" title="commit by Pavel Sklenar(pavel.sklenar@cloudfield.cz) f5d3ae45f5183f44c2c5404fa2bb327ad1e0ed43: Initial migration commit">
<i class="fas fa-hashtag fa-fw"></i>f5d3ae4</a></span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/parallel-processing-java/index.md target=_blank rel="noopener noreferrer">Read Markdown</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.pavelsklenar.com/parallel-processing-java/ data-title="Parallel Processing in Java"><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://blog.pavelsklenar.com/parallel-processing-java/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://blog.pavelsklenar.com/parallel-processing-java/ data-title="Parallel Processing in Java" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.pavelsklenar.com/parallel-processing-java/ data-title="Parallel Processing in Java"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Pocket" data-sharer=pocket data-url=https://blog.pavelsklenar.com/parallel-processing-java/><i class="fab fa-get-pocket fa-fw"></i></a><a href=javascript:void(0); title="Share on Evernote" data-sharer=evernote data-url=https://blog.pavelsklenar.com/parallel-processing-java/ data-title="Parallel Processing in Java"><i class="fab fa-evernote fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/using-filteredrowset-simple-example/ class=prev rel=prev title="Using JDBC FilteredRowSet - Simple Example"><i class="fas fa-angle-left fa-fw"></i>Using JDBC FilteredRowSet - Simple Example</a>
<a href=/spring-integration-sftp-upload-example/ class=next rel=next title="Spring Integration: SFTP Upload Example using Key-Based Authentication">Spring Integration: SFTP Upload Example using Key-Based Authentication<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript><div id=valine class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2015 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">Pavel Sklenar</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=/lib/valine/valine.min.css><script type=text/javascript src=https://pavelsklenar.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:70},comment:{valine:{appId:"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI",appKey:"WBmoGyJtbqUswvfLh6L8iEBr",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"en",pageSize:10,placeholder:"Your comment ...",recordIP:!0,serverURLs:"https://leancloud.hugoCodeIT.com",visitor:!0}},search:{algoliaAppID:"FCUIGZY2I2",algoliaIndex:"index.en",algoliaSearchKey:"c8c5599716aec462e125eea72ac52f41",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.47a1ff73dc443ed4a9f13e3134f6058e8c6d21248b35d03e7d64f56345190c3e.js integrity="sha256-R6H/c9xEPtSp8T4xNPYFjoxtISSLNdA+fWT1Y0UZDD4="></script></body>
</html>