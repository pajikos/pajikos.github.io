<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Azure Functions in Kubernetes Example - blog.pavelsklenar.com</title><meta name=description content="Personal blog page"><meta property="og:title" content="Azure Functions in Kubernetes Example"><meta property="og:description" content="Introduction This tutorial shows how to deploy two simple examples of Azure Functions written in Python to Kubernetes (AKS used here, but not required).
Envrironment setup Install prerequisites  Docker (e.g. https://www.docker.com/products/docker-desktop) Kubectl (https://kubernetes.io/docs/tasks/tools/install-kubectl/) Azure cli (https://docs.microsoft.com/cs-cz/cli/azure/install-azure-cli) Func cli (https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local)  Login to the Docker registry You need a Docker registry with push rights to be able to upload images with two functions. You have to be logged, here is an example when using Azure Container Registry:"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.pavelsklenar.com/azure-functions-in-k8s/"><meta property="og:image" content="https://blog.pavelsklenar.com/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-31T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-31T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.pavelsklenar.com/logo.png"><meta name=twitter:title content="Azure Functions in Kubernetes Example"><meta name=twitter:description content="Introduction This tutorial shows how to deploy two simple examples of Azure Functions written in Python to Kubernetes (AKS used here, but not required).
Envrironment setup Install prerequisites  Docker (e.g. https://www.docker.com/products/docker-desktop) Kubectl (https://kubernetes.io/docs/tasks/tools/install-kubectl/) Azure cli (https://docs.microsoft.com/cs-cz/cli/azure/install-azure-cli) Func cli (https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local)  Login to the Docker registry You need a Docker registry with push rights to be able to upload images with two functions. You have to be logged, here is an example when using Azure Container Registry:"><meta name=application-name content="blog.pavelsklenar.com"><meta name=apple-mobile-web-app-title content="blog.pavelsklenar.com"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.pavelsklenar.com/azure-functions-in-k8s/><link rel=prev href=https://blog.pavelsklenar.com/two-node-nomad-cluster/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.623091c4f3b927646c79b3db3772f496ee423628b9567bc0c74af55a4d50d1ba.css integrity="sha256-YjCRxPO5J2RsebPbN3L0lu5CNii5VnvAx0r1Wk1Q0bo="><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Azure Functions in Kubernetes Example","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.pavelsklenar.com\/azure-functions-in-k8s\/"},"image":[{"@type":"ImageObject","url":"https:\/\/blog.pavelsklenar.com\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"posts","keywords":"cloud, azure, functions, keda, service-bus","wordcount":700,"url":"https:\/\/blog.pavelsklenar.com\/azure-functions-in-k8s\/","datePublished":"2022-03-31T00:00:00+00:00","dateModified":"2022-03-31T00:00:00+00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Pavel Sklenar","logo":{"@type":"ImageObject","url":"https:\/\/blog.pavelsklenar.com\/images\/avatar.png","width":250,"height":250}},"author":{"@type":"Person","name":"Pavel Sklenar"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>("false"==="true"&&window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=blog.pavelsklenar.com><span class=header-title-pre><i class="fas fa-code-branch fa-fw"></i></span>blog.pavelsklenar.com</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/pajikos title=GitHub rel="noopener noreferrer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=blog.pavelsklenar.com><span class=header-title-pre><i class="fas fa-code-branch fa-fw"></i></span>blog.pavelsklenar.com</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/pajikos title=GitHub rel="noopener noreferrer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Azure Functions in Kubernetes Example</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Pavel Sklenar</a></span>&nbsp;<span class=post-category>included in <a href=/categories/azure/><i class="far fa-folder fa-fw"></i>azure</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-03-31>2022-03-31</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;700 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#envrironment-setup>Envrironment setup</a><ul><li><a href=#install-prerequisites>Install prerequisites</a></li><li><a href=#login-to-the-docker-registry>Login to the Docker registry</a></li><li><a href=#download-functions-source-code>Download Functions source code</a></li><li><a href=#setup-your-custom-properties>Setup your custom properties</a></li><li><a href=#load-envrironment-properties>Load envrironment properties</a></li><li><a href=#deploy-keda-to-cluster>Deploy KEDA to cluster</a><ul><li><a href=#create-namespace-for-keda>Create namespace for Keda</a></li></ul></li></ul></li><li><a href=#deploying-azure-functions-non-durable-function>Deploying Azure Functions (non-durable function)</a><ul><li><a href=#setup-servicebus-namespace>Setup ServiceBus Namespace</a></li><li><a href=#test-local-run>Test local run</a></li><li><a href=#building-and-deploying-the-testing-function>Building and deploying the testing function</a></li><li><a href=#setting-access-to-deployed-app>Setting access to deployed app</a></li><li><a href=#test-consuming-messages-from-the-queue>Test consuming messages from the queue</a></li></ul></li><li><a href=#clean-resources>Clean resources</a></li><li><a href=#resources>Resources</a></li></ul></nav></div></div><div class=content id=content><h2 id=introduction>Introduction</h2><p>This tutorial shows how to deploy two simple examples of Azure Functions written in Python to Kubernetes (AKS used here, but not required).</p><h2 id=envrironment-setup>Envrironment setup</h2><h3 id=install-prerequisites>Install prerequisites</h3><ul><li>Docker (e.g. <a href=https://www.docker.com/products/docker-desktop target=_blank rel="noopener noreferrer">https://www.docker.com/products/docker-desktop</a>)</li><li>Kubectl (<a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/ target=_blank rel="noopener noreferrer">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a>)</li><li>Azure cli (<a href=https://docs.microsoft.com/cs-cz/cli/azure/install-azure-cli target=_blank rel="noopener noreferrer">https://docs.microsoft.com/cs-cz/cli/azure/install-azure-cli</a>)</li><li>Func cli (<a href=https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local</a>)</li></ul><h3 id=login-to-the-docker-registry>Login to the Docker registry</h3><p>You need a Docker registry with push rights to be able to upload images with two functions.
You have to be logged, here is an example when using Azure Container Registry:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Auth with AAD accounts</span>
</span></span><span class=line><span class=cl>az acr login -n <span class=nv>$ACR_NAME</span>
</span></span></code></pre></div><h3 id=download-functions-source-code>Download Functions source code</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone git@github.com:pajikos/cloud-samples.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> cloud-samples/azure-functions-in-k8s
</span></span></code></pre></div><h3 id=setup-your-custom-properties>Setup your custom properties</h3><p>Edit file <code>.env</code> and fill correct values.</p><h3 id=load-envrironment-properties>Load envrironment properties</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Load env properties</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> .env
</span></span></code></pre></div><h3 id=deploy-keda-to-cluster>Deploy KEDA to cluster</h3><p>For more info, visit: <a href=https://keda.sh/docs/2.6/deploy/ target=_blank rel="noopener noreferrer">https://keda.sh/docs/2.6/deploy/</a>
Please note, that you do not need Keda version 2.2 and above(required for Durable Functions only).</p><h4 id=create-namespace-for-keda>Create namespace for Keda</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Create namespace</span>
</span></span><span class=line><span class=cl>kubectl create namespace keda
</span></span></code></pre></div><p>There are two ways how to deploy KEDA:</p><ul><li>Install Keda using Azure Func Core Tools</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Deploy keda</span>
</span></span><span class=line><span class=cl>func kubernetes install --namespace keda
</span></span></code></pre></div><ul><li>Install Keda using the official Helm chart</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Add Helm repo</span>
</span></span><span class=line><span class=cl>helm repo add kedacore https://kedacore.github.io/charts
</span></span><span class=line><span class=cl><span class=c1>#Update Helm repo</span>
</span></span><span class=line><span class=cl>helm repo update
</span></span><span class=line><span class=cl><span class=c1># Create namespace</span>
</span></span><span class=line><span class=cl>kubectl create namespace keda
</span></span><span class=line><span class=cl><span class=c1>#Install keda Helm chart</span>
</span></span><span class=line><span class=cl>helm install keda kedacore/keda --namespace keda
</span></span></code></pre></div><h2 id=deploying-azure-functions-non-durable-function>Deploying Azure Functions (non-durable function)</h2><p>This example shows how to deploy two functions to the AKS cluster:</p><ul><li>Simple HTTP Trigger-based function - return response to HTTP GET imediately.</li><li>ServiceBus trigger-based function - automatic scaling based on the number of messages in a queue, simply consuming messages and logging them to console</li></ul><h3 id=setup-servicebus-namespace>Setup ServiceBus Namespace</h3><p>One of the functions uses Azure Service Bus, so here is the tutorial on how to create it using az cli:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>az servicebus namespace create --resource-group <span class=nv>$RG</span> --name <span class=nv>$SERVICEBUS_NAMESPACE</span> --location <span class=nv>$LOC</span> --sku Standard
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az servicebus queue create --name <span class=nv>$QUEUE_NAME</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --resource-group <span class=nv>$RG</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --namespace-name <span class=nv>$SERVICEBUS_NAMESPACE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>az servicebus queue authorization-rule create --resource-group <span class=nv>$RG</span> --namespace-name <span class=nv>$SERVICEBUS_NAMESPACE</span> --queue-name <span class=nv>$QUEUE_NAME</span> --name <span class=nv>$POLICY_NAME</span> --rights Listen Send Manage
</span></span><span class=line><span class=cl><span class=nv>PRIMARY_KEY</span><span class=o>=</span><span class=k>$(</span>az servicebus queue authorization-rule keys list --resource-group <span class=nv>$RG</span> --namespace-name <span class=nv>$SERVICEBUS_NAMESPACE</span> --queue-name queue-input --name <span class=nv>$POLICY_NAME</span> --query primaryKey --output tsv<span class=k>)</span>   
</span></span><span class=line><span class=cl><span class=c1># Assign env property with connection strings to queue</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ServiceBusConnectionString</span><span class=o>=</span><span class=s2>&#34;Endpoint=sb://</span><span class=nv>$SERVICEBUS_NAMESPACE</span><span class=s2>.servicebus.windows.net/;SharedAccessKeyName=</span><span class=nv>$POLICY_NAME</span><span class=s2>;SharedAccessKey=</span><span class=nv>$PRIMARY_KEY</span><span class=s2>;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Keda needs Connection string including entity path (i.e. the full path)</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ServiceBusConnectionStringQueue</span><span class=o>=</span><span class=s2>&#34;Endpoint=sb://</span><span class=nv>$SERVICEBUS_NAMESPACE</span><span class=s2>.servicebus.windows.net/;SharedAccessKeyName=</span><span class=nv>$POLICY_NAME</span><span class=s2>;SharedAccessKey=</span><span class=nv>$PRIMARY_KEY</span><span class=s2>;EntityPath=</span><span class=nv>$QUEUE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Run the following lines and insert the output to local.settings.json </span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;\&#34;ServiceBusConnectionStringQueue\&#34;: \&#34;</span><span class=nv>$ServiceBusConnectionStringQueue</span><span class=s2>\&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;\&#34;ServiceBusConnectionString\&#34;: \&#34;</span><span class=nv>$ServiceBusConnectionString</span><span class=s2>\&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Optional, Getting root access key (= global access to the whole namespace)</span>
</span></span><span class=line><span class=cl><span class=nv>ROOT_CONNECTION_STRING</span><span class=o>=</span><span class=k>$(</span>az servicebus namespace authorization-rule keys list --resource-group <span class=nv>$RG</span> --namespace-name <span class=nv>$SERVICEBUS_NAMESPACE</span> --name RootManageSharedAccessKey --query primaryConnectionString --output tsv<span class=k>)</span>
</span></span></code></pre></div><h3 id=test-local-run>Test local run</h3><p>If the Azure Service Bus and queue successfully installed, you can run functions locally:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> simple_function_demo
</span></span><span class=line><span class=cl>func start
</span></span></code></pre></div><p>If no problem, successful output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>[azure-functions-in-k8s/simple_function_demo]func start
</span></span></span><span class=line><span class=cl><span class=go>Found Python version 3.9.10 (python3).
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Azure Functions Core Tools
</span></span></span><span class=line><span class=cl><span class=go>Core Tools Version:       4.0.3971 Commit hash: d0775d487c93ebd49e9c1166d5c3c01f3c76eaaf  (64-bit)
</span></span></span><span class=line><span class=cl><span class=go>Function Runtime Version: 4.0.1.16815
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>...
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Functions:
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>  HttpTriggerTest: [GET,POST] http://localhost:7071/api/HttpTriggerTest
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>  ServiceBusQueueTrigger: serviceBusTrigger
</span></span></span></code></pre></div><h3 id=building-and-deploying-the-testing-function>Building and deploying the testing function</h3><p>If run local properly, we can now deploy functions to AKS.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>FUNCTION_NAME</span><span class=o>=</span>k8sfntest
</span></span><span class=line><span class=cl><span class=nv>FUNCTION_NS_NAME</span><span class=o>=</span>functions-test
</span></span><span class=line><span class=cl>func kubernetes deploy --name <span class=nv>$FUNCTION_NAME</span> --min-replicas <span class=m>0</span> --max-replicas <span class=m>5</span> --cooldown-period <span class=m>30</span> --image-name <span class=nv>$ACR_NAME</span>.azurecr.io/functiontestdeploy:latest --namespace <span class=nv>$FUNCTION_NS_NAME</span> -i --dry-run &gt; deployment.yaml
</span></span></code></pre></div><p>The following steps are needed:</p><ol><li>Open deployment.yaml for editing</li><li>Find definition of ScaledObject (k8sfntest) and replace: ServiceBusConnectionString -> ServiceBusConnectionStringQueueInput (Kuda Azure ServiceBus integration needs full queue endpoint.)</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Create namespace</span>
</span></span><span class=line><span class=cl>kubectl create namespace <span class=nv>$FUNCTION_NS_NAME</span>
</span></span><span class=line><span class=cl><span class=c1># Run deployment</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml -n <span class=nv>$FUNCTION_NS_NAME</span>
</span></span></code></pre></div><h3 id=setting-access-to-deployed-app>Setting access to deployed app</h3><p>A new service during deployment was created, so here you can extract its external service IP.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># list all running services</span>
</span></span><span class=line><span class=cl>kubectl get services --namespace <span class=nv>$FUNCTION_NS_NAME</span>
</span></span><span class=line><span class=cl><span class=c1># Save service IP to variable</span>
</span></span><span class=line><span class=cl><span class=nv>SERVICE_IP</span><span class=o>=</span><span class=k>$(</span>k get svc <span class=nv>$FUNCTION_NAME</span>-http --namespace <span class=nv>$FUNCTION_NS_NAME</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.loadBalancer.ingress[*].ip}&#39;</span><span class=k>)</span>
</span></span></code></pre></div><p>Go to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Invoke url: http://</span><span class=nv>$SERVICE_IP</span><span class=s2>/api/httptriggertest?name=Pavel&#34;</span>
</span></span></code></pre></div><h3 id=test-consuming-messages-from-the-queue>Test consuming messages from the queue</h3><p>To send a batch of messages to the Azure Service Bus namespace, you can do it on Azure Portal or simply use my Python script.
Install script dependencies first:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install azure.servicebus
</span></span></code></pre></div><p>In the Azure Service Bus section of this page, a connection string was exported as an environment variable, so you can now run the script directly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python send_message.py
</span></span></code></pre></div><p>Successful output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Sent a list of 100 messages
</span></span></span><span class=line><span class=cl><span class=go>Sent a batch of 100 messages
</span></span></span><span class=line><span class=cl><span class=go>Done sending messages
</span></span></span><span class=line><span class=cl><span class=go>-----------------------
</span></span></span></code></pre></div><h2 id=clean-resources>Clean resources</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl delete namespace <span class=nv>$FUNCTION_NS_NAME</span>
</span></span></code></pre></div><h2 id=resources>Resources</h2><ul><li><a href=https://docs.microsoft.com/en-us/azure/azure-functions/functions-kubernetes-keda target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/azure-functions/functions-kubernetes-keda</a></li><li><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-core-tools-reference?tabs=v2#func-kubernetes-deploy" target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/azure-functions/functions-core-tools-reference?tabs=v2#func-kubernetes-deploy</a></li><li><a href=https://www.wesleyhaakman.org/scaling-azure-functions-from-zero-to-n-hero-on-kubernetes-with-keda/ target=_blank rel="noopener noreferrer">https://www.wesleyhaakman.org/scaling-azure-functions-from-zero-to-n-hero-on-kubernetes-with-keda/</a></li><li><a href=https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-queues target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-queues</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-03-31</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/azure-functions-in-k8s/index.md target=_blank rel="noopener noreferrer">Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.pavelsklenar.com/azure-functions-in-k8s/ data-title="Azure Functions in Kubernetes Example" data-hashtags=cloud,azure,functions,keda,service-bus><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://blog.pavelsklenar.com/azure-functions-in-k8s/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://blog.pavelsklenar.com/azure-functions-in-k8s/ data-title="Azure Functions in Kubernetes Example" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://blog.pavelsklenar.com/azure-functions-in-k8s/ data-title="Azure Functions in Kubernetes Example"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Pocket" data-sharer=pocket data-url=https://blog.pavelsklenar.com/azure-functions-in-k8s/><i class="fab fa-get-pocket fa-fw"></i></a><a href=javascript:void(0); title="Share on Evernote" data-sharer=evernote data-url=https://blog.pavelsklenar.com/azure-functions-in-k8s/ data-title="Azure Functions in Kubernetes Example"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/cloud/>cloud</a>,&nbsp;<a href=/tags/azure/>azure</a>,&nbsp;<a href=/tags/functions/>functions</a>,&nbsp;<a href=/tags/keda/>keda</a>,&nbsp;<a href=/tags/service-bus/>service-bus</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/two-node-nomad-cluster/ class=prev rel=prev title="Creating two node Nomad cluster"><i class="fas fa-angle-left fa-fw"></i>Creating two node Nomad cluster</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2015 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">Pavel Sklenar</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://pavelsklenar.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:70},comment:{},search:{algoliaAppID:"FCUIGZY2I2",algoliaIndex:"index.en",algoliaSearchKey:"c8c5599716aec462e125eea72ac52f41",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.47a1ff73dc443ed4a9f13e3134f6058e8c6d21248b35d03e7d64f56345190c3e.js integrity="sha256-R6H/c9xEPtSp8T4xNPYFjoxtISSLNdA+fWT1Y0UZDD4="></script></body></html>